{"ast":null,"code":"import authAPI from \"../api/api.js\";\nconst SET_AUTH_USER = \"SET_AUTH_USER\";\nconst RESET_USER_AUTH_DATA = \"RESET_USER_AUTH_DATA\";\nconst GET_CAPTCHA_URL_SUCCESS = \"GET_CAPTCHA_URL_SUCCESS\";\nconst SET_ACCESS_TOKEN = \"SET_ACCESS_TOKEN\";\nconst SET_REFRESH_TOKEN = \"SET_REFRESH_TOKEN\";\nlet initialState = {\n  username: null,\n  loglast_name: null,\n  last_name: null,\n  email: null,\n  isAuth: false,\n  accessToken: \"\",\n  refreshToken: \"\"\n};\nconst AuthReducer = (state = initialState, action) => {\n  switch (action.type) {\n    case SET_ACCESS_TOKEN:\n      return {\n        ...state,\n        accessToken: action.accessToken\n      };\n    case SET_REFRESH_TOKEN:\n      return {\n        ...state,\n        refreshToken: action.refreshToken\n      };\n    case SET_AUTH_USER:\n    case GET_CAPTCHA_URL_SUCCESS:\n      return {\n        ...state,\n        ...action.payload\n      };\n    case RESET_USER_AUTH_DATA:\n      return {\n        // ...state,\n        ...initialState\n      };\n    default:\n      return state;\n  }\n};\n_c = AuthReducer;\nexport default AuthReducer;\nexport const authUser = () => {\n  debugger;\n  return async (dispatch, getState) => {\n    const {\n      refreshToken\n    } = getState().auth;\n    console.log('State: ', refreshToken);\n    const response = await authAPI.authMe(refreshToken);\n    if (response.status === 200) {\n      dispatch(setAccessToken(response.data.access));\n      dispatch(setRefreshToken(response.data.refresh));\n    }\n  };\n};\nexport const getAauthUser = () => {\n  return async (dispatch, getState) => {\n    try {\n      // console.log('Trying to authenticate...');\n      const response = await authAPI.getAythUser();\n      if (response.status === 200) {\n        let {\n          username,\n          first_name,\n          last_name,\n          email\n        } = response.data.data;\n        console.log(username, first_name, last_name, email);\n        console.log(response.data.data);\n        dispatch(setAuthUser(username, first_name, last_name, email, true));\n      }\n    } catch (error) {\n      // Если запрос к authMe завершился ошибкой, попробовать обновить токен\n      if (error.response && error.response.status === 403 && error.response.data.detail === \"Given token not valid for any token type\") {\n        try {\n          const {\n            refreshToken\n          } = getState().AuthReducer; // Получаем refresh token из localStorage\n\n          if (refreshToken) {\n            const response = await authAPI.refreshToken(refreshToken);\n            localStorage.setAccessToken(response.data.access);\n            localStorage.setRefreshToken(response.data.refresh);\n            const newResponse = await authAPI.authMe();\n            if (newResponse.data.resultCode === 0) {\n              let {\n                id,\n                login,\n                email\n              } = newResponse.data.data;\n              dispatch(setAuthUser(id, login, email, true));\n            }\n          }\n        } catch (refreshError) {\n          // Здесь вы можете выполнить какие-то дополнительные действия при неудачной попытке обновления токена\n          dispatch(resetAuthDataAC());\n          setAccessToken(\"\");\n          setRefreshToken(\"\");\n        }\n      }\n    }\n  };\n};\nexport const register = (fullName, login, email, password, repidPassword, setStatus) => {\n  return async dispatch => {\n    const response = await authAPI.registerUser(fullName, login, email, password, repidPassword);\n    if (response.data.resultCode === 0) {\n      localStorage.setItem('userToken', response.data.data.token);\n      localStorage.setItem('refreshToken', response.data.data.refreshToken);\n      // dispatch(getAauthUser());\n    } else {\n      setStatus(response.data.email[0]);\n    }\n  };\n};\nexport const login = (username, password, setStatus) => {\n  return async dispatch => {\n    const response = await authAPI.loginUser(username, password);\n    console.log('Что то тут', response.data.detail);\n    if (response.status === 200) {\n      dispatch(setAccessToken(response.data.access));\n      dispatch(setRefreshToken(response.data.refresh));\n      localStorage.setItem(\"refreshToken\", response.data.refresh);\n      dispatch(getAauthUser());\n    } else if (response.status === 401) {\n      console.log(response);\n      setStatus(response.detail);\n    }\n  };\n};\nexport const logout = () => {\n  return async dispatch => {\n    try {\n      const response = await authAPI.logout();\n      if (response.data.resultCode === 0) {\n        dispatch(resetAuthDataAC());\n        setAccessToken(\"\");\n        setRefreshToken(\"\");\n      }\n    } catch (error) {\n      // Обработка ошибок при выходе\n      console.error('Logout error:', error);\n    }\n  };\n};\n\n//Вывод стрелочной ф-и без return возможен, если функция только возвращает обьекты, после => нужно обернуть в ()\nexport const setAuthUser = (username, first_name, last_name, email, isAuth) => ({\n  type: SET_AUTH_USER,\n  payload: {\n    username,\n    first_name,\n    last_name,\n    email,\n    isAuth\n  }\n});\nexport const getCaptchaUrlSuccess = captchaUrl => ({\n  type: GET_CAPTCHA_URL_SUCCESS,\n  payload: {\n    captchaUrl\n  }\n});\nexport const resetAuthDataAC = () => {\n  return {\n    type: RESET_USER_AUTH_DATA\n  };\n};\nexport const setAccessToken = accessToken => ({\n  type: SET_ACCESS_TOKEN,\n  accessToken\n});\nexport const setRefreshToken = refreshToken => ({\n  type: SET_REFRESH_TOKEN,\n  refreshToken\n});\nvar _c;\n$RefreshReg$(_c, \"AuthReducer\");","map":{"version":3,"names":["authAPI","SET_AUTH_USER","RESET_USER_AUTH_DATA","GET_CAPTCHA_URL_SUCCESS","SET_ACCESS_TOKEN","SET_REFRESH_TOKEN","initialState","username","loglast_name","last_name","email","isAuth","accessToken","refreshToken","AuthReducer","state","action","type","payload","_c","authUser","dispatch","getState","auth","console","log","response","authMe","status","setAccessToken","data","access","setRefreshToken","refresh","getAauthUser","getAythUser","first_name","setAuthUser","error","detail","localStorage","newResponse","resultCode","id","login","refreshError","resetAuthDataAC","register","fullName","password","repidPassword","setStatus","registerUser","setItem","token","loginUser","logout","getCaptchaUrlSuccess","captchaUrl","$RefreshReg$"],"sources":["/home/dima_protasevich/Documents/PycharmProjects/student_app_test/frontend/src/reduser/auth-reduser.js"],"sourcesContent":["import authAPI from \"../api/api.js\";\n\nconst SET_AUTH_USER = \"SET_AUTH_USER\"\nconst RESET_USER_AUTH_DATA = \"RESET_USER_AUTH_DATA\"\nconst GET_CAPTCHA_URL_SUCCESS = \"GET_CAPTCHA_URL_SUCCESS\"\nconst SET_ACCESS_TOKEN = \"SET_ACCESS_TOKEN\";\nconst SET_REFRESH_TOKEN = \"SET_REFRESH_TOKEN\";\n\n\nlet initialState = {\n  username: null,\n  loglast_name: null,\n  last_name: null,\n  email: null,\n  isAuth: false,\n  accessToken: \"\",\n  refreshToken: \"\",\n};\n\nconst AuthReducer = (state = initialState, action) => {\n\n    switch (action.type) {\n\n        case SET_ACCESS_TOKEN:\n            return {\n                ...state,\n                accessToken: action.accessToken\n            }\n        \n        case SET_REFRESH_TOKEN:\n            return {\n              ...state,\n              refreshToken: action.refreshToken\n            };\n\n        case SET_AUTH_USER:\n        case GET_CAPTCHA_URL_SUCCESS:\n            return {\n                ...state, \n                ...action.payload\n                }\n\n        case RESET_USER_AUTH_DATA:\n            return {\n                // ...state,\n                ...initialState\n            }\n        \n        default:\n            return state\n    }\n}\n\nexport default AuthReducer\n\n\nexport const authUser = () => {\n    debugger\n    return async (dispatch, getState) => {\n        const { refreshToken } = getState().auth;\n        console.log('State: ', refreshToken)\n        const response = await authAPI.authMe(refreshToken);\n        if (response.status === 200) {\n            dispatch(setAccessToken(response.data.access));\n            dispatch(setRefreshToken(response.data.refresh));\n        }\n    };\n};\n\n\nexport const getAauthUser = () => {\n    return async (dispatch, getState) => {\n      try {\n        // console.log('Trying to authenticate...');\n        const response = await authAPI.getAythUser();\n        if (response.status === 200) {\n          let { username, first_name, last_name, email } = response.data.data;\n          console.log(username, first_name, last_name, email);\n          console.log(response.data.data);\n          dispatch(setAuthUser(username, first_name, last_name, email, true));\n        }\n      } catch (error) {\n        // Если запрос к authMe завершился ошибкой, попробовать обновить токен\n        if (\n          error.response &&\n          error.response.status === 403 &&\n          error.response.data.detail ===\n            \"Given token not valid for any token type\"\n        ) {\n          try {\n            const { refreshToken } = getState().AuthReducer; // Получаем refresh token из localStorage\n\n            if (refreshToken) {\n              const response = await authAPI.refreshToken(refreshToken);\n\n              localStorage.setAccessToken(response.data.access);\n              localStorage.setRefreshToken(response.data.refresh);\n\n              const newResponse = await authAPI.authMe();\n              if (newResponse.data.resultCode === 0) {\n                let { id, login, email } = newResponse.data.data;\n                dispatch(setAuthUser(id, login, email, true));\n              }\n            }\n          } catch (refreshError) {\n            // Здесь вы можете выполнить какие-то дополнительные действия при неудачной попытке обновления токена\n            dispatch(resetAuthDataAC());\n            setAccessToken(\"\");\n            setRefreshToken(\"\");\n          }\n        }\n      }\n    };\n};\n\n\nexport const register = (fullName, login, email, password, repidPassword, setStatus) => {\n    return async (dispatch) => {\n        const response = await authAPI.registerUser(fullName, login, email, password, repidPassword)\n        if (response.data.resultCode === 0) {\n            localStorage.setItem('userToken', response.data.data.token);\n            localStorage.setItem('refreshToken', response.data.data.refreshToken);\n            // dispatch(getAauthUser());\n        } else {\n            setStatus(response.data.email[0]);\n        }\n    }\n}\n\n\nexport const login = (username, password, setStatus) => {\n  return async (dispatch) => {\n    const response = await authAPI.loginUser(username, password);\n    console.log('Что то тут', response.data.detail)\n    if (response.status === 200) {\n\n        dispatch(setAccessToken(response.data.access));\n        dispatch(setRefreshToken(response.data.refresh));\n        localStorage.setItem(\"refreshToken\", response.data.refresh);\n        dispatch(getAauthUser());\n    } else if (response.status === 401) {\n        console.log(response)\n        setStatus(response.detail);\n    }\n  };\n};\n\nexport const logout = () => {\n    return async (dispatch) => {\n        try {\n            const response = await authAPI.logout();\n            if (response.data.resultCode === 0) {\n                dispatch(resetAuthDataAC());\n                setAccessToken(\"\");\n                setRefreshToken(\"\");\n            }\n        } catch (error) {\n            // Обработка ошибок при выходе\n            console.error('Logout error:', error);\n        }\n    };\n};\n\n\n\n//Вывод стрелочной ф-и без return возможен, если функция только возвращает обьекты, после => нужно обернуть в ()\nexport const setAuthUser = (username, first_name, last_name, email, isAuth) => ({ type: SET_AUTH_USER, payload: {username, first_name, last_name, email, isAuth} })\nexport const getCaptchaUrlSuccess = (captchaUrl) => ({ type: GET_CAPTCHA_URL_SUCCESS, payload: {captchaUrl} })\nexport const resetAuthDataAC = () => {return { type: RESET_USER_AUTH_DATA }}\nexport const setAccessToken = (accessToken) => ({type: SET_ACCESS_TOKEN, accessToken})\nexport const setRefreshToken = (refreshToken) => ({type: SET_REFRESH_TOKEN, refreshToken})\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}